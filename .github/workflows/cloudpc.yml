name: Cloud PC Full XFCE

on:
  workflow_dispatch:

jobs:
  cloudpc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Update system
      run: |
        sudo apt update && sudo apt upgrade -y

    - name: Install desktop environment + VNC
      run: |
        sudo apt install -y \
          xfce4 xfce4-goodies \
          dbus-x11 x11-xserver-utils \
          tigervnc-standalone-server \
          tigervnc-common \
          novnc websockify \
          firefox

    - name: Create VNC password
      run: |
        mkdir -p ~/.vnc
        echo "cloudpc" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

    - name: Configure VNC startup
      run: |
        echo '#!/bin/sh
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        exec startxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup

    - name: Start VNC server
      run: |
        vncserver -localhost no :1 -geometry 1280x720 -depth 24

    - name: Start noVNC (browser access)
      run: |
        websockify --web=/usr/share/novnc/ 6080 localhost:5901 &

    - name: Info
      run: |
        echo "=================================="
        echo "Cloud PC ONLINE"
        echo "VNC password: cloudpc"
        echo "Browser: port 6080"
        echo "VNC: port 5901"
        echo "=================================="

    - name: Keep alive
      run: |
        sleep 6h
