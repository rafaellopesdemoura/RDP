name: Cloud PC noVNC (Public)

on:
  workflow_dispatch:

jobs:
  cloudpc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Update
      run: |
        sudo apt update

    - name: Install desktop and tools
      run: |
        sudo apt install -y \
          xfce4 xfce4-goodies \
          firefox \
          x11vnc xvfb \
          novnc websockify \
          wget curl

    - name: Start desktop and VNC
      run: |
        Xvfb :0 -screen 0 1280x720x16 &
        sleep 3
        startxfce4 &
        sleep 5
        x11vnc -display :0 -nopw -forever -shared -rfbport 5900 &

    - name: Start noVNC
      run: |
        websockify --web=/usr/share/novnc 6080 localhost:5900 &

    - name: Start Cloudflare Tunnel
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        ./cloudflared-linux-amd64 tunnel --url http://localhost:6080 --no-autoupdate &
        sleep 5

    - name: Show public link
      run: |
        echo "======================================"
        echo "COPIA O LINK CLOUDflare QUE APARECE ACIMA"
        echo "Ã‰ ELE QUE ABRE O CLOUD PC"
        echo "======================================"

    - name: Keep alive
      run: sleep 6h
